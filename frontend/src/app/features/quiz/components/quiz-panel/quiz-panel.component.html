<div class="bg-base-200 rounded-lg p-6 flex flex-col h-full">
  <!-- Loading State: Modern Circular Progress -->
  <div *ngIf="isLoading"
    class="flex flex-col items-center justify-center h-full p-4 animate-in fade-in zoom-in duration-500">
    <div class="relative w-48 h-48 md:w-64 md:h-64 flex items-center justify-center">
      <!-- Progress Circle SVG -->
      <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
        <!-- Static background circle -->
        <circle class="text-base-300 stroke-current" stroke-width="6" fill="transparent" r="42" cx="50" cy="50" />

        <!-- Dynamic progress circle -->
        <circle class="text-brand-500 stroke-current transition-all duration-300 ease-out" stroke-width="6"
          stroke-linecap="round" fill="transparent" r="42" cx="50" cy="50" [attr.stroke-dasharray]="263.89"
          [attr.stroke-dashoffset]="263.89 * (1 - displayProgress / 100)" />
      </svg>

      <!-- Center text content -->
      <div class="absolute inset-0 flex flex-col items-center justify-center">
        <!-- Time elapsed -->
        <span class="text-xs md:text-sm font-medium text-content-300 mb-1">
          {{ formatTime(streamingProgress.elapsedTime) }}
        </span>

        <!-- Percentage Progress -->
        <div class="flex items-baseline gap-0.5">
          <span class="text-5xl md:text-7xl font-black text-content-100 tabular-nums">
            {{ displayProgress | number:'1.0-0' }}
          </span>
          <span class="text-2xl md:text-3xl font-bold text-brand-500">%</span>
        </div>

        <!-- Label -->
        <span class="text-[10px] md:text-xs font-bold text-content-300 tracking-[0.2em] uppercase mt-2">
          {{ (streamingProgress.status === 'SAVING' ? 'QUIZ.SAVING' : 'QUIZ.GENERATING') | translate }}
        </span>
      </div>
    </div>

    <!-- Status Messages -->
    <div class="mt-10 text-center max-w-sm">
      <h3 class="text-lg md:text-xl font-bold text-content-100 mb-2">
        {{ (streamingProgress.status === 'SAVING' ? 'QUIZ.SAVING' : 'QUIZ.GENERATING') | translate }}
      </h3>
      <p class="text-sm text-content-200">
        {{ (streamingProgress.status === 'SAVING' ? 'QUIZ.SAVING_DESC' : 'QUIZ.GENERATING_DESC') | translate }}
      </p>

      <!-- Subtle indeterminate progress bar for 'Saving' state -->
      <div class="mt-4 h-1 w-32 mx-auto bg-base-300 rounded-full overflow-hidden"
        *ngIf="streamingProgress.status === 'SAVING'">
        <div class="h-full bg-brand-500 animate-loading-bar rounded-full"></div>
      </div>
    </div>
  </div>

  <!-- No Quiz State -->
  <div *ngIf="!isLoading && !quiz" class="flex flex-col items-center justify-center h-full text-center">
    <h3 class="text-2xl font-bold text-content-100 mb-2">{{ 'QUIZ.TITLE_ADAPTIVE' | translate }}</h3>
    <p class="text-content-200">
      {{ 'QUIZ.DESC_ADAPTIVE' | translate }}
    </p>
    <p class="mt-4 p-2 bg-base-300 rounded-md text-brand-500 font-mono text-sm">
      {{ 'QUIZ.EXAMPLE_PROMPT' | translate }}
    </p>
  </div>

  <!-- Quiz Completed -->
  <div *ngIf="!isLoading && quiz && quizState && quizState.finished"
    class="text-center flex flex-col items-center justify-center h-full p-6">
    <h3 class="text-2xl font-bold text-content-100 mb-2">{{ 'QUIZ.COMPLETED_TITLE' | translate }}</h3>
    <p class="text-lg text-content-200 mb-4">{{ 'QUIZ.SCORED' | translate }}</p>
    <div class="text-6xl font-extrabold text-brand-500 mb-6">
      {{ quizState.score }}<span class="text-4xl text-content-200">/{{ quiz.questions.length }}</span>
    </div>
    <button (click)="onRestart()" class="btn btn-primary">
      {{ 'QUIZ.RESTART_BUTTON' | translate }}
    </button>
    <p class="text-sm text-gray-500 mt-4">{{ 'QUIZ.RETURN_INSTRUCTION' | translate }}</p>
  </div>

  <!-- Active Quiz -->
  <div *ngIf="!isLoading && quiz && quizState && !quizState.finished" class="flex flex-col h-full">
    <header class="mb-6">
      <h2 class="text-2xl font-bold text-content-100 mb-2">{{ 'QUIZ.TITLE_TOPIC' | translate:{topic: quiz.topic} }}</h2>
      <div>
        <p class="text-sm text-content-200 mb-2">
          {{ 'QUIZ.QUESTION_PROGRESS' | translate:{current: quizState.currentQuestionIndex + 1, total:
          quiz.questions.length} }}
        </p>
        <div class="w-full bg-base-300 rounded-full h-2.5">
          <div class="bg-brand-500 h-2.5 rounded-full transition-all duration-500"
            [style.width.%]="getProgressPercentage()"></div>
        </div>
      </div>
    </header>

    <div class="flex-1">
      <h3 class="text-lg font-semibold text-content-100 mb-4">{{ currentQuestion?.question }}</h3>
      <div class="space-y-3">
        <label *ngFor="let option of currentQuestion?.options; let i = index" [for]="'option-' + i"
          [class]="getOptionClasses(option)">
          <input [id]="'option-' + i" type="radio" name="quiz-option" [value]="option"
            [checked]="selectedOption === option" (change)="onOptionSelect(option)" [disabled]="isSubmitted"
            class="radio radio-primary" />
          <span class="ml-4 text-content-200">{{ option }}</span>
        </label>
      </div>
    </div>

    <!-- Explanation -->
    <div *ngIf="isSubmitted" class="mt-6 p-4 rounded-lg" [ngClass]="{
        'bg-green-500/10 text-green-300': userAnswer === currentQuestion?.correctAnswer,
        'bg-red-500/10 text-red-300': userAnswer !== currentQuestion?.correctAnswer
      }">
      <h4 class="font-bold mb-1">
        {{ userAnswer === currentQuestion?.correctAnswer ? ('QUIZ.CORRECT' | translate) : ('QUIZ.INCORRECT' | translate)
        }}
      </h4>
      <p class="text-sm">{{ currentQuestion?.explanation }}</p>
    </div>

    <!-- Actions -->
    <div class="mt-6">
      <button *ngIf="!isSubmitted" (click)="onSubmit()" [disabled]="!selectedOption" class="btn btn-primary w-full">
        {{ 'QUIZ.SUBMIT_BUTTON' | translate }}
      </button>

      <div *ngIf="isSubmitted" class="flex gap-2">
        <button *ngIf="quizState.currentQuestionIndex > 0" (click)="onPrevious()" class="btn btn-secondary flex-1">
          {{ 'QUIZ.PREVIOUS_BUTTON' | translate }}
        </button>

        <button *ngIf="quizState.currentQuestionIndex < quiz.questions.length - 1" (click)="onNext()"
          class="btn btn-primary flex-1">
          {{ 'QUIZ.NEXT_BUTTON' | translate }}
        </button>

        <button *ngIf="quizState.currentQuestionIndex === quiz.questions.length - 1" (click)="onFinish()"
          class="btn btn-primary flex-1">
          {{ 'QUIZ.FINISH_BUTTON' | translate }}
        </button>
      </div>
    </div>
  </div>

  <p class="text-[10px] text-content-300/50 text-center mt-auto pt-4 font-medium tracking-tight">
    {{ 'COMMON.AI_DISCLAIMER' | translate }}
  </p>
</div>