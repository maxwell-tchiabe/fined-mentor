<div class="bg-base-200 rounded-lg p-6 flex flex-col h-full">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex flex-col items-center justify-center h-full">
    <app-loading-spinner size="lg"></app-loading-spinner>
    <p class="text-content-200 mt-4">Generating your quiz...</p>
  </div>

  <!-- No Quiz State -->
  <div *ngIf="!isLoading && !quiz" class="flex flex-col items-center justify-center h-full text-center">
    <h3 class="text-2xl font-bold text-content-100 mb-2">Adaptive Assessment</h3>
    <p class="text-content-200">
      Ready for a challenge? Ask the mentor in the chat to test you on a topic, for example:
    </p>
    <p class="mt-4 p-2 bg-base-300 rounded-md text-brand-500 font-mono text-sm">
      "Test me on real estate investing"
    </p>
  </div>

  <!-- Quiz Completed -->
  <div *ngIf="!isLoading && quiz && quizState && quizState.finished"
    class="text-center flex flex-col items-center justify-center h-full p-6">
    <h3 class="text-2xl font-bold text-content-100 mb-2">Quiz Completed!</h3>
    <p class="text-lg text-content-200 mb-4">You scored</p>
    <div class="text-6xl font-extrabold text-brand-500 mb-6">
      {{ quizState.score }}<span class="text-4xl text-content-200">/{{ quiz.questions.length }}</span>
    </div>
    <button (click)="onRestart()" class="btn btn-primary">
      Take Another Quiz
    </button>
    <p class="text-sm text-gray-500 mt-4">Return to the chat to start a new test.</p>
  </div>

  <!-- Active Quiz -->
  <div *ngIf="!isLoading && quiz && quizState && !quizState.finished" class="flex flex-col h-full">
    <header class="mb-6">
      <h2 class="text-2xl font-bold text-content-100 mb-2">Quiz: {{ quiz.topic }}</h2>
      <div>
        <p class="text-sm text-content-200 mb-2">
          Question {{ quizState.currentQuestionIndex + 1 }} of {{ quiz.questions.length }}
        </p>
        <div class="w-full bg-base-300 rounded-full h-2.5">
          <div class="bg-brand-500 h-2.5 rounded-full transition-all duration-500"
            [style.width.%]="getProgressPercentage()"></div>
        </div>
      </div>
    </header>

    <div class="flex-1">
      <h3 class="text-lg font-semibold text-content-100 mb-4">{{ currentQuestion?.question }}</h3>
      <div class="space-y-3">
        <label *ngFor="let option of currentQuestion?.options; let i = index" [for]="'option-' + i"
          [class]="getOptionClasses(option)">
          <input [id]="'option-' + i" type="radio" name="quiz-option" [value]="option"
            [checked]="selectedOption === option" (change)="onOptionSelect(option)" [disabled]="isSubmitted"
            class="radio radio-primary" />
          <span class="ml-4 text-content-200">{{ option }}</span>
        </label>
      </div>
    </div>

    <!-- Explanation -->
    <div *ngIf="isSubmitted" class="mt-6 p-4 rounded-lg" [ngClass]="{
        'bg-green-500/10 text-green-300': userAnswer === currentQuestion?.correctAnswer,
        'bg-red-500/10 text-red-300': userAnswer !== currentQuestion?.correctAnswer
      }">
      <h4 class="font-bold mb-1">
        {{ userAnswer === currentQuestion?.correctAnswer ? 'Correct!' : 'Incorrect' }}
      </h4>
      <p class="text-sm">{{ currentQuestion?.explanation }}</p>
    </div>

    <!-- Actions -->
    <div class="mt-6">
      <button *ngIf="!isSubmitted" (click)="onSubmit()" [disabled]="!selectedOption" class="btn btn-primary w-full">
        Submit Answer
      </button>

      <div *ngIf="isSubmitted" class="flex gap-2">
        <button *ngIf="quizState.currentQuestionIndex > 0" (click)="onPrevious()" class="btn btn-secondary flex-1">
          Previous
        </button>

        <button *ngIf="quizState.currentQuestionIndex < quiz.questions.length - 1" (click)="onNext()"
          class="btn btn-primary flex-1">
          Next Question
        </button>

        <button *ngIf="quizState.currentQuestionIndex === quiz.questions.length - 1" (click)="onFinish()"
          class="btn btn-primary flex-1">
          Finish Quiz
        </button>
      </div>
    </div>
  </div>
</div>